<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cross-Browser PDF Generation Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    button {
      padding: 10px 15px;
      margin: 10px 5px 10px 0;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s, transform 0.1s;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #3700b3;
    }
    .browser-info {
      margin: 10px 0;
      font-style: italic;
      color: #555;
    }
    .log {
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      margin-top: 20px;
      white-space: pre-wrap;
    }
    .success {
      color: #007E33;
    }
    .error {
      color: #CC0000;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Cross-Browser PDF Generation Test</h1>
    
    <div class="browser-info">
      <h3>Browser Details</h3>
      <p><strong>You are using:</strong> <span id="browser-name">Detecting...</span></p>
      <p>This test page helps diagnose PDF generation issues across different browsers.</p>
    </div>
    
    <div class="test-options">
      <div class="test-card">
        <h3>Basic Test Report</h3>
        <p>Generate a simple PDF with default options using mock data.</p>
        <p><strong>Features:</strong> Standard formatting, default margins</p>
        <button id="test-pdf-basic" class="primary">Generate Basic PDF</button>
      </div>
      
      <div class="test-card">
        <h3>Advanced Test Report</h3>
        <p>Generate a PDF with custom options and complex mock data.</p>
        <p><strong>Features:</strong> Custom margins, background printing, complex chart data</p>
        <button id="test-pdf-simplified">Generate Advanced PDF</button>
      </div>
    </div>
    
    <div class="panel">
      <h3>Debug Log</h3>
      <p>Detailed information about the PDF generation process will appear below:</p>
      <div class="log-container" id="log"></div>
    </div>
  </div>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://tbpnsxwldrxdlirxfcor.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRicG5zeHdsZHJ4ZGxpcnhmY29yIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzM0NjIwMTMsImV4cCI6MTk4OTAzODAxM30.Z0oA51_WJk0Epl4FoA9ORXkhoIQqw0dDKuHo7x2MKhw';
    
    // Initialize the Supabase client
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Will be populated with real report IDs from the database
    // Fallback to these test IDs if database fetch fails
    const TEST_REPORT_IDS = {
      basic: "00000000-0000-4000-a000-000000000001",
      complex: "00000000-0000-4000-a000-000000000002"
    };

    // Log function
    function log(message, type = 'info') {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toISOString().substring(11, 19);
      const logMessage = `[${timestamp}] ${message}`;
      
      const messageElement = document.createElement('div');
      messageElement.textContent = logMessage;
      messageElement.className = type;
      
      logElement.appendChild(messageElement);
      logElement.scrollTop = logElement.scrollHeight;
    }

    // Detect browser
    function detectBrowser() {
      const userAgent = navigator.userAgent;
      let browserName = "Unknown";
      let browserVersion = "";
      
      if (userAgent.match(/Safari/) && !userAgent.match(/Chrome/)) {
        browserName = "Safari";
        const versionMatch = userAgent.match(/Version\/(\d+\.\d+)/);
        browserVersion = versionMatch ? versionMatch[1] : "";
      } else if (userAgent.match(/Chrome/)) {
        browserName = "Chrome";
        const versionMatch = userAgent.match(/Chrome\/(\d+\.\d+)/);
        browserVersion = versionMatch ? versionMatch[1] : "";
      } else if (userAgent.match(/Firefox/)) {
        browserName = "Firefox";
        const versionMatch = userAgent.match(/Firefox\/(\d+\.\d+)/);
        browserVersion = versionMatch ? versionMatch[1] : "";
      } else if (userAgent.match(/Edge/)) {
        browserName = "Edge";
        const versionMatch = userAgent.match(/Edge\/(\d+\.\d+)/);
        browserVersion = versionMatch ? versionMatch[1] : "";
      }
      
      document.getElementById('browser-name').textContent = `${browserName} ${browserVersion}`;
      
      return { browserName, browserVersion, userAgent };
    }

    // Generate PDF function
    async function generatePDF(reportId, simplified = false, mockReport = null) {
      try {
        const browserInfo = detectBrowser();
        log(`Starting PDF generation for report ${reportId} using ${browserInfo.browserName} ${browserInfo.browserVersion}`);
        
        const options = simplified ? { 
          format: "A4",
          printBackground: true,
          margin: { top: "20mm", right: "20mm", bottom: "20mm", left: "20mm" },
          preferCssPageSize: false,
          scale: 1.0
        } : {};
        
        // Create payload with mock data if available
        const payload = {
          reportId,
          browserInfo: {
            name: browserInfo.browserName,
            version: browserInfo.browserVersion,
            userAgent: browserInfo.userAgent.substring(0, 200) // Trim to avoid potential size limits
          },
          options,
          templateId: null,
          templateContent: null,
          mockData: mockReport ? {
            reportData: mockReport.data,
            userProfile: {
              display_name: "Test User",
              email: "test@example.com"
            },
            isMockReport: true
          } : null
        };
        
        log(`Sending request to Edge Function with payload: ${JSON.stringify(payload, null, 2)}`);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-pdf-report`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        // Check HTTP status first
        if (!response.ok) {
          log(`✗ HTTP Error: ${response.status} ${response.statusText}`, 'error');
          try {
            const errorData = await response.json();
            log(`Response details: ${JSON.stringify(errorData, null, 2)}`, 'error');
          } catch (e) {
            const text = await response.text();
            log(`Response body: ${text.substring(0, 500)}`, 'error');
          }
          return;
        }
        
        // Parse JSON response
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          log(`✗ Failed to parse response as JSON: ${jsonError.message}`, 'error');
          const text = await response.text();
          log(`Response body: ${text.substring(0, 500)}`, 'error');
          return;
        }
        
        if (data.success && data.downloadUrl) {
          log(`✓ PDF generated successfully! Download URL: ${data.downloadUrl}`, 'success');
          
          // Create debug info section
          const debugInfo = document.createElement('div');
          debugInfo.className = 'success';
          debugInfo.innerHTML = `<strong>PDF Info:</strong><br>
          - Generated at: ${new Date().toISOString()}<br>
          - Browser: ${browserInfo.browserName} ${browserInfo.browserVersion}<br>
          - Size: ${data.pdfSize || 'Unknown'} bytes<br>
          - Options: ${JSON.stringify(options)}`;
          
          const logElement = document.getElementById('log');
          logElement.appendChild(debugInfo);
          
          // Open PDF in new tab
          const link = document.createElement('a');
          link.href = data.downloadUrl;
          link.target = '_blank';
          link.textContent = 'Open PDF';
          link.style.color = '#0066cc';
          link.style.textDecoration = 'underline';
          link.style.cursor = 'pointer';
          link.style.fontWeight = 'bold';
          link.style.fontSize = '16px';
          link.style.display = 'block';
          link.style.margin = '10px 0';
          link.style.padding = '5px';
          
          logElement.appendChild(link);
          
          // Auto-open in Safari to test the browser's PDF handling
          if (browserInfo.browserName === 'Safari') {
            log('Automatically opening PDF in Safari for testing...', 'info');
            window.open(data.downloadUrl, '_blank');
          }
          
        } else {
          log(`✗ PDF generation failed: ${data.error || 'Unknown error'}`, 'error');
          if (data.errorDetails) {
            log(`Error details: ${JSON.stringify(data.errorDetails, null, 2)}`, 'error');
          }
          
          // Special error handling for better diagnostics
          if (data.screenshotUrl) {
            log(`Debug screenshot available: ${data.screenshotUrl}`, 'info');
            const imgLink = document.createElement('a');
            imgLink.href = data.screenshotUrl;
            imgLink.target = '_blank';
            imgLink.textContent = 'View debug screenshot';
            imgLink.style.color = '#0066cc';
            
            const logElement = document.getElementById('log');
            logElement.appendChild(imgLink);
            logElement.appendChild(document.createElement('br'));
          }
        }
      } catch (error) {
        log(`✗ Exception: ${error.message}`, 'error');
        log(`Stack trace: ${error.stack}`, 'error');
      }
    }

    // Create mock report data for testing
    function createMockReports() {
      log('Creating mock report data for testing...');
      const mockReports = [
        {
          id: "test-report-basic",
          name: "Basic Test Report",
          mock: true,
          data: {
            name: "Test Subject",
            birth_date: "1990-01-01",
            birth_time: "12:00",
            birth_location: "New York, NY",
            chart_data: JSON.stringify({
              sun: "Capricorn",
              moon: "Taurus",
              rising: "Libra"
            })
          }
        },
        {
          id: "test-report-complex",
          name: "Complex Test Report",
          mock: true,
          data: {
            name: "Complex Subject",
            birth_date: "1985-07-15",
            birth_time: "15:30",
            birth_location: "Los Angeles, CA",
            chart_data: JSON.stringify({
              sun: "Cancer",
              moon: "Virgo",
              rising: "Gemini",
              planets: [
                { name: "Mercury", sign: "Cancer" },
                { name: "Venus", sign: "Leo" },
                { name: "Mars", sign: "Libra" }
              ]
            })
          }
        }
      ];
      
      log(`✓ Created ${mockReports.length} mock reports for testing`, 'success');
      return mockReports;
    }
    
    // Update the UI with available reports
    function updateReportsUI(reports) {
      const reportsContainer = document.getElementById('reports-container');
      reportsContainer.innerHTML = '';
      
      reports.forEach((report, index) => {
        const li = document.createElement('li');
        li.textContent = `${report.name || 'Unnamed Report'} (${report.id})`;
        reportsContainer.appendChild(li);
        
        // Set the first report as the default test report
        if (index === 0) {
          TEST_REPORT_IDS.basic = report.id;
        }
        // Set the second report (or first again if only one exists) as the complex test report
        if (index === 1 || (index === 0 && reports.length === 1)) {
          TEST_REPORT_IDS.complex = report.id;
        }
      });
      
      // Update UI display
      document.getElementById('reports-loading').style.display = 'none';
      document.getElementById('reports-list').style.display = 'block';
      
      // Enable buttons if we have report IDs
      const hasReportId = TEST_REPORT_IDS.basic !== null;
      document.getElementById('test-pdf-basic').disabled = !hasReportId;
      document.getElementById('test-pdf-simplified').disabled = !hasReportId;
      
      if (hasReportId) {
        log(`Selected test report ID: ${TEST_REPORT_IDS.basic}`, 'info');
      } else {
        log('No valid report ID available for testing', 'error');
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      // Detect browser
      detectBrowser();
      
      // Use mock reports instead of database fetch
      const mockReports = createMockReports();
      updateReportsUI(mockReports);
      
      // Update test report IDs with mock data
      TEST_REPORT_IDS.basic = mockReports[0].id;
      TEST_REPORT_IDS.complex = mockReports[1].id;
      
      // Set up event listeners
      document.getElementById('test-pdf-basic').addEventListener('click', () => {
        generatePDF(TEST_REPORT_IDS.basic, false, mockReports[0]);
      });
      
      document.getElementById('test-pdf-simplified').addEventListener('click', () => {
        generatePDF(TEST_REPORT_IDS.complex, true, mockReports[1]);
      });
      
      log('PDF Generation Test page loaded. Click a button to begin testing.');
    });
  </script>
</body>
</html>
